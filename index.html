<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>StudyLog â€” å­¦ç¿’è¨˜éŒ²</title>

  <!-- Chart.js CDN -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

  <!-- Google Fonts: Noto Sans JP (æœ¬æ–‡) + Lexend (æ•°å­—ãƒ»è‹±èªè¦‹å‡ºã—) -->

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Lexend:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    /* ============================================================
       CSS å¤‰æ•° & ãƒªã‚»ãƒƒãƒˆ
    ============================================================ */
    :root {
      --bg:        #0e0f14;
      --surface:   #16181f;
      --surface2:  #1e2029;
      --border:    #2a2d3a;
      --accent:    #6ee7b7;   /* ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
      --accent2:   #818cf8;   /* ã‚¤ãƒ³ãƒ‡ã‚£ã‚´ */
      --accent3:   #fbbf24;   /* ã‚¢ãƒ³ãƒãƒ¼ */
      --danger:    #f87171;
      --text:      #e2e8f0;
      --text-sub:  #8892a4;
      --radius:    16px;
      --radius-sm: 10px;
      --tab-h:     60px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    /* ============================================================
       ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    ============================================================ */
    #app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸ */
    .screen {
      display: none;
      flex: 1;
      padding: 24px 16px calc(var(--tab-h) + 24px);
      overflow-y: auto;
      animation: fadeUp .3s ease both;
    }
    .screen.active { display: block; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ============================================================
       ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    ============================================================ */
    #nav {
      position: fixed;
      bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%; max-width: 480px;
      height: var(--tab-h);
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border: none;
      background: none;
      color: var(--text-sub);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 10px;
      cursor: pointer;
      transition: color .2s;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-btn svg { width: 22px; height: 22px; transition: transform .2s; }
    .nav-btn.active { color: var(--accent); }
    .nav-btn.active svg { transform: scale(1.15); }

    /* ============================================================
       å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    ============================================================ */
    .page-title {
      font-family: 'Lexend', sans-serif;
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 24px;
      letter-spacing: -.02em;
    }
    .page-title span { color: var(--accent); }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--text-sub);
      margin-bottom: 12px;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ  */
    input[type="number"] {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      color: var(--text);
      font-size: 20px;
      font-family: 'Lexend', sans-serif;
      font-weight: 600;
      outline: none;
      transition: border-color .2s;
      -webkit-appearance: none;
    }
    input[type="number"]:focus {
      border-color: var(--accent);
    }
    input[type="number"]::placeholder { color: var(--text-sub); }

    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³ */
    .btn-primary {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: #0e0f14;
      font-family: 'Lexend', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .15s, opacity .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary:active { transform: scale(.97); opacity: .85; }

    /* äºŒæ¬¡ãƒœã‚¿ãƒ³ */
    .btn-secondary {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface2);
      color: var(--text);
      font-family: 'Lexend', sans-serif;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: border-color .2s, transform .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-secondary:active { transform: scale(.97); }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    #toast {
      position: fixed;
      bottom: calc(var(--tab-h) + 16px);
      left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--accent);
      color: #0e0f14;
      font-weight: 700;
      font-size: 13px;
      padding: 10px 20px;
      border-radius: 999px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s, transform .3s;
      z-index: 200;
      white-space: nowrap;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ============================================================
       1. ç›®æ¨™è¨­å®šç”»é¢
    ============================================================ */
    .goal-hero {
      background: linear-gradient(135deg, #1a2a3a 0%, var(--surface) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .goal-hero .hero-num {
      font-family: 'Lexend', sans-serif;
      font-size: 52px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .goal-hero .hero-unit { font-size: 13px; color: var(--text-sub); margin-top: 4px; }

    .info-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 20px;
    }
    .info-chip .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent2);
    }

    /* ============================================================
       2. è¨˜éŒ²ç”»é¢
    ============================================================ */
    /* ç§‘ç›®ã‚»ãƒ¬ã‚¯ã‚¿ */
    .subject-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 4px;
    }
    .subject-btn {
      aspect-ratio: 1;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface2);
      color: var(--text-sub);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      -webkit-tap-highlight-color: transparent;
    }
    .subject-btn.selected {
      border-color: var(--accent);
      background: rgba(110,231,183,.12);
      color: var(--accent);
    }

    /* ç§‘ç›®ã‚«ãƒ©ãƒ¼ */
    .subject-btn[data-subject="å›½èª"].selected  { border-color:#f87171; background:rgba(248,113,113,.12); color:#f87171; }
    .subject-btn[data-subject="æ•°å­¦"].selected  { border-color:#818cf8; background:rgba(129,140,248,.12); color:#818cf8; }
    .subject-btn[data-subject="è‹±èª"].selected  { border-color:#6ee7b7; background:rgba(110,231,183,.12); color:#6ee7b7; }
    .subject-btn[data-subject="ç†ç§‘"].selected  { border-color:#fbbf24; background:rgba(251,191,36,.12);  color:#fbbf24; }
    .subject-btn[data-subject="ç¤¾ä¼š"].selected  { border-color:#c084fc; background:rgba(192,132,252,.12); color:#c084fc; }

    /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
    .timer-display {
      text-align: center;
      padding: 32px 0 20px;
    }
    .timer-clock {
      font-family: 'Lexend', sans-serif;
      font-size: 56px;
      font-weight: 800;
      letter-spacing: .06em;
      color: var(--text);
      line-height: 1;
    }
    .timer-clock.running { color: var(--accent); }
    .timer-clock-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text-sub);
      margin-top: 6px;
    }
    .timer-status {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 8px;
    }

    /* é–‹å§‹ãƒ»çµ‚äº†ãƒœã‚¿ãƒ³è¡Œ */
    .record-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .btn-start {
      padding: 18px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: #0e0f14;
      font-family: 'Lexend', sans-serif;
      font-size: 16px; font-weight: 800;
      cursor: pointer;
      transition: transform .15s, opacity .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-stop {
      padding: 18px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--danger);
      color: #fff;
      font-family: 'Lexend', sans-serif;
      font-size: 16px; font-weight: 800;
      cursor: pointer;
      transition: transform .15s, opacity .15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-start:active, .btn-stop:active { transform: scale(.96); opacity: .85; }
    .btn-start:disabled, .btn-stop:disabled {
      opacity: .3; cursor: not-allowed; transform: none;
    }

    /* æœ€è¿‘ã®è¨˜éŒ²ãƒªã‚¹ãƒˆ */
    .record-list { list-style: none; }
    .record-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .record-item:last-child { border-bottom: none; }
    .record-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .record-info { flex: 1; }
    .record-subject { font-weight: 700; font-size: 14px; }
    .record-date { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .record-dur {
      font-family: 'Lexend', sans-serif;
      font-size: 15px; font-weight: 700;
      color: var(--text-sub);
    }

    .empty-msg {
      text-align: center;
      color: var(--text-sub);
      font-size: 13px;
      padding: 24px 0;
    }

    /* ============================================================
       3. é€²æ—ç”»é¢
    ============================================================ */
    /* é€²æ—ãƒªãƒ³ã‚° (SVG) */
    .progress-ring-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 0 20px;
    }
    .ring-container { position: relative; width: 160px; height: 160px; }
    .ring-bg, .ring-fg {
      fill: none;
      stroke-width: 12;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    .ring-bg { stroke: var(--surface2); }
    .ring-fg {
      stroke: var(--accent);
      stroke-linecap: round;
      transition: stroke-dashoffset .6s cubic-bezier(.4,0,.2,1);
    }
    .ring-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .ring-pct {
      font-family: 'Lexend', sans-serif;
      font-size: 30px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .ring-label { font-size: 11px; color: var(--text-sub); margin-top: 2px; }

    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--text-sub);
      margin-bottom: 6px;
    }
    .stat-val {
      font-family: 'Lexend', sans-serif;
      font-size: 26px; font-weight: 800;
      line-height: 1;
    }
    .stat-unit { font-size: 13px; font-weight: 400; color: var(--text-sub); margin-left: 3px; }
    .stat-val.good { color: var(--accent); }
    .stat-val.warn { color: var(--accent3); }
    .stat-val.bad  { color: var(--danger); }

    /* ã‚°ãƒ©ãƒ•ãƒ©ãƒƒãƒ‘ãƒ¼ */
    .chart-wrap {
      position: relative;
      height: 220px;
      margin-top: 4px;
    }
  </style>

</head>
<body>
<div id="app">

  <!-- ============================================================
       ç”»é¢ 1: ç›®æ¨™è¨­å®š
  ============================================================ -->

  <section id="screen-goal" class="screen active">
    <h1 class="page-title">ç›®æ¨™<span>è¨­å®š</span></h1>

```
<!-- ç¾åœ¨ã®ç›®æ¨™è¡¨ç¤º -->
<div class="goal-hero">
  <div class="hero-num" id="goal-display-min">---</div>
  <div class="hero-unit">ç¾åœ¨ã®é€±é–“ç›®æ¨™ï¼ˆåˆ†ï¼‰</div>
</div>

<div class="info-chip">
  <span class="dot"></span>
  ãƒ¢ãƒ¼ãƒ‰ï¼šç›´è¿‘1é€±é–“
</div>

<div class="card">
  <div class="card-label">é€±é–“ç›®æ¨™æ™‚é–“ã‚’è¨­å®š</div>
  <!-- ç›®æ¨™åˆ†æ•°å…¥åŠ› -->
  <input
    type="number"
    id="goal-input"
    placeholder="ä¾‹ï¼š300ï¼ˆ5æ™‚é–“ï¼‰"
    min="1" max="9999"
    inputmode="numeric"
  />
  <p style="font-size:12px;color:var(--text-sub);margin:8px 0 16px;">
    â€» 1æ™‚é–“ = 60åˆ†
  </p>
  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <button class="btn-primary" id="btn-save-goal">ä¿å­˜ã™ã‚‹</button>
</div>

<!-- ã‚ˆãã‚ã‚‹ç›®æ¨™å€¤ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ -->
<div class="card">
  <div class="card-label">ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š</div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
    <button class="btn-secondary quick-goal" data-min="120">2h</button>
    <button class="btn-secondary quick-goal" data-min="300">5h</button>
    <button class="btn-secondary quick-goal" data-min="420">7h</button>
    <button class="btn-secondary quick-goal" data-min="600">10h</button>
  </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ -->
<div class="card">
  <div class="card-label">ãƒ‡ãƒ¼ã‚¿ä¿è­·</div>
  <p style="font-size:12px;color:var(--text-sub);margin-bottom:12px;">
    ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ãŒã€æ‰‹å‹•ã§ã‚‚ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã™
  </p>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
    <button class="btn-secondary" id="btn-export">
      <svg style="width:16px;height:16px;margin-bottom:-2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      ä¿å­˜
    </button>
    <button class="btn-secondary" id="btn-import">
      <svg style="width:16px;height:16px;margin-bottom:-2px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      å¾©å…ƒ
    </button>
  </div>
  <input type="file" id="file-import" accept=".json" style="display:none;" />
</div>
```

  </section>

  <!-- ============================================================
       ç”»é¢ 2: å­¦ç¿’è¨˜éŒ²
  ============================================================ -->

  <section id="screen-record" class="screen">
    <h1 class="page-title">å­¦ç¿’<span>è¨˜éŒ²</span></h1>

```
<div class="card">
  <div class="card-label">ç§‘ç›®ã‚’é¸ã¶</div>
  <!-- ç§‘ç›®é¸æŠãƒœã‚¿ãƒ³ -->
  <div class="subject-grid">
    <button class="subject-btn" data-subject="å›½èª">å›½èª</button>
    <button class="subject-btn" data-subject="æ•°å­¦">æ•°å­¦</button>
    <button class="subject-btn" data-subject="è‹±èª">è‹±èª</button>
    <button class="subject-btn" data-subject="ç†ç§‘">ç†ç§‘</button>
    <button class="subject-btn" data-subject="ç¤¾ä¼š">ç¤¾ä¼š</button>
  </div>
</div>

<div class="card">
  <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆé–‹å§‹æ™‚åˆ»ï¼‰ -->
  <div class="timer-display">
    <div class="timer-clock-label" id="timer-clock-label">ã€€</div>
    <div class="timer-clock" id="timer-clock">--:--</div>
    <div class="timer-status" id="timer-status">ç§‘ç›®ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„</div>
  </div>
  <!-- é–‹å§‹ãƒ»çµ‚äº†ãƒœã‚¿ãƒ³ -->
  <div class="record-actions">
    <button class="btn-start" id="btn-start" disabled>é–‹å§‹</button>
    <button class="btn-stop"  id="btn-stop"  disabled>çµ‚äº†</button>
  </div>
</div>

<!-- æœ€è¿‘ã®è¨˜éŒ²ï¼ˆç›´è¿‘5ä»¶ï¼‰ -->
<div class="card">
  <div class="card-label">æœ€è¿‘ã®è¨˜éŒ²</div>
  <ul class="record-list" id="recent-list">
    <li class="empty-msg">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>
  </ul>
</div>
```

  </section>

  <!-- ============================================================
       ç”»é¢ 3: é€²æ—ãƒ»å¯è¦–åŒ–
  ============================================================ -->

  <section id="screen-progress" class="screen">
    <h1 class="page-title">é€²æ—<span>ç¢ºèª</span></h1>

```
<!-- é”æˆç‡ãƒªãƒ³ã‚° -->
<div class="card">
  <div class="card-label">ä»Šé€±ã®é”æˆç‡</div>
  <div class="progress-ring-wrap">
    <div class="ring-container">
      <svg viewBox="0 0 160 160" width="160" height="160">
        <circle class="ring-bg" cx="80" cy="80" r="68" />
        <circle class="ring-fg" id="ring-fg" cx="80" cy="80" r="68"
          stroke-dasharray="427.26"
          stroke-dashoffset="427.26" />
      </svg>
      <div class="ring-text">
        <div class="ring-pct" id="ring-pct">0%</div>
        <div class="ring-label">é”æˆ</div>
      </div>
    </div>
  </div>
</div>

<!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
<div class="stats-row">
  <div class="stat-card">
    <div class="stat-label">ä»Šé€±ã®åˆè¨ˆ</div>
    <div class="stat-val good" id="stat-total">0<span class="stat-unit">åˆ†</span></div>
  </div>
  <div class="stat-card">
    <div class="stat-label">æ®‹ã‚Šæ™‚é–“</div>
    <div class="stat-val" id="stat-remain">---<span class="stat-unit">åˆ†</span></div>
  </div>
</div>

<!-- ç§‘ç›®åˆ¥æ£’ã‚°ãƒ©ãƒ• -->
<div class="card">
  <div class="card-label">ç§‘ç›®åˆ¥ é›†è¨ˆï¼ˆåˆ†ï¼‰</div>
  <div class="chart-wrap">
    <canvas id="subject-chart"></canvas>
  </div>
</div>

<!-- æ—¥åˆ¥ã‚°ãƒ©ãƒ• -->
<div class="card">
  <div class="card-label">æ—¥åˆ¥ æ¨ç§»ï¼ˆåˆ†ï¼‰</div>
  <div class="chart-wrap">
    <canvas id="daily-chart"></canvas>
  </div>
</div>
```

  </section>

  <!-- ============================================================
       ãƒœãƒˆãƒ ãƒŠãƒ“
  ============================================================ -->

  <nav id="nav">
    <!-- ç›®æ¨™è¨­å®šã‚¿ãƒ– -->
    <button class="nav-btn active" data-target="screen-goal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
      </svg>
      ç›®æ¨™
    </button>
    <!-- è¨˜éŒ²ã‚¿ãƒ– -->
    <button class="nav-btn" data-target="screen-record">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
      è¨˜éŒ²
    </button>
    <!-- é€²æ—ã‚¿ãƒ– -->
    <button class="nav-btn" data-target="screen-progress">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="14"/>
      </svg>
      é€²æ—
    </button>
  </nav>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->

  <div id="toast"></div>
</div>

<!-- ============================================================
     JavaScript
============================================================ -->

<script>
/* ================================================================
   å®šæ•° & ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
================================================================ */

/** ç§‘ç›®ã”ã¨ã®è‰²å®šç¾© */
const SUBJECT_COLORS = {
  'å›½èª': '#f87171',
  'æ•°å­¦': '#818cf8',
  'è‹±èª': '#6ee7b7',
  'ç†ç§‘': '#fbbf24',
  'ç¤¾ä¼š': '#c084fc',
};

/* ================================================================
   LocalStorage ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·å¼·åŒ–ç‰ˆï¼‰
   
   ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã‚’é˜²ããŸã‚ã«ä»¥ä¸‹ã®å¯¾ç­–ã‚’å®Ÿè£…ï¼š
   1. ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ + ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®äºŒé‡ä¿å­˜
   2. ä¿å­˜å‰å¾Œã®æ¤œè¨¼ï¼ˆæ›¸ãè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãèª­ã‚ã‚‹ã‹ç¢ºèªï¼‰
   3. ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§3å›ï¼‰
   4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆç ´ææ¤œå‡ºï¼‰
================================================================ */

const STORAGE_KEY = 'studylog_v1';           // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
const BACKUP_KEY  = 'studylog_v1_backup';    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

/** ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’å–å¾—ã™ã‚‹ã€‚å­˜åœ¨ã—ãªã‘ã‚Œã°åˆæœŸå€¤ã‚’è¿”ã™ */
function loadData() {
  const defaultData = { records: [], goal: { mode: 'weekly', targetMinutes: 300 } };
  
  // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿è©¦è¡Œ
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const data = JSON.parse(raw);
      // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (validateData(data)) {
        return data;
      }
      console.warn('ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã¾ã™ã€‚');
    }
  } catch (e) {
    console.error('ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•—:', e);
  }
  
  // ãƒ¡ã‚¤ãƒ³å¤±æ•—æ™‚ï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
  try {
    const backupRaw = localStorage.getItem(BACKUP_KEY);
    if (backupRaw) {
      const backupData = JSON.parse(backupRaw);
      if (validateData(backupData)) {
        console.info('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰æ­£å¸¸ã«å¾©å…ƒã—ã¾ã—ãŸ');
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ¡ã‚¤ãƒ³ã«æ›¸ãæˆ»ã™
        saveData(backupData);
        return backupData;
      }
    }
  } catch (e) {
    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å¤±æ•—:', e);
  }
  
  // ã™ã¹ã¦å¤±æ•—æ™‚ï¼šåˆæœŸå€¤ã‚’è¿”ã™
  console.warn('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆæœŸå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
  return defaultData;
}

/** ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹ */
function validateData(data) {
  if (!data || typeof data !== 'object') return false;
  if (!Array.isArray(data.records)) return false;
  if (!data.goal || typeof data.goal !== 'object') return false;
  if (typeof data.goal.targetMinutes !== 'number') return false;
  
  // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯ï¼ˆtimestampã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
  for (const rec of data.records) {
    if (!rec.date || !rec.subject || typeof rec.duration !== 'number') {
      return false;
    }
    // timestampã¯æ–°è¦è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã§ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã¯å­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹
    if (rec.timestamp !== undefined && typeof rec.timestamp !== 'number') {
      return false;
    }
  }
  return true;
}

/** ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’ä¿å­˜ã™ã‚‹ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰ */
function saveData(data) {
  const maxRetries = 3;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const json = JSON.stringify(data);
      
      // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem(STORAGE_KEY, json);
      
      // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem(BACKUP_KEY, json);
      
      // ä¿å­˜æ¤œè¨¼ï¼šæ›¸ãè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãèª­ã‚ã‚‹ã‹ç¢ºèª
      const verify = localStorage.getItem(STORAGE_KEY);
      if (verify !== json) {
        throw new Error('ä¿å­˜æ¤œè¨¼å¤±æ•—ï¼šæ›¸ãè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ãŒä¸€è‡´ã—ã¾ã›ã‚“');
      }
      
      // æˆåŠŸ
      if (attempt > 1) {
        console.log(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ (è©¦è¡Œ ${attempt}/${maxRetries})`);
      }
      return true;
      
    } catch (e) {
      console.error(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜å¤±æ•— (è©¦è¡Œ ${attempt}/${maxRetries}):`, e);
      
      if (attempt === maxRetries) {
        // æœ€çµ‚è©¦è¡Œã‚‚å¤±æ•—
        showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return false;
      }
      
      // ãƒªãƒˆãƒ©ã‚¤å‰ã«å°‘ã—å¾…æ©Ÿ
      const delay = attempt * 100;
      const start = Date.now();
      while (Date.now() - start < delay) { /* busy wait */ }
    }
  }
  return false;
}

/* ================================================================
   æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
================================================================ */

/** Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ 'YYYY-MM-DD' æ–‡å­—åˆ— */
function toDateStr(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

/** ç›´è¿‘ 7 æ—¥é–“ã®æ—¥ä»˜æ–‡å­—åˆ—ãƒªã‚¹ãƒˆã‚’æ–°ã—ã„é †ã§è¿”ã™ */
function getWeekDates() {
  const result = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    result.push(toDateStr(d));
  }
  return result;
}

/** ç›´è¿‘ 7 æ—¥é–“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦è¿”ã™ */
function getWeekRecords(records) {
  const weekDates = new Set(getWeekDates());
  return records.filter(r => weekDates.has(r.date));
}

/* ================================================================
   ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
================================================================ */
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2400);
}

/* ================================================================
   ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSPA çš„ç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼‰
================================================================ */
const navBtns  = document.querySelectorAll('.nav-btn');
const screens  = document.querySelectorAll('.screen');

function switchScreen(targetId) {
  // å…¨ç”»é¢ã‚’éè¡¨ç¤º
  screens.forEach(s => s.classList.remove('active'));
  navBtns.forEach(b => b.classList.remove('active'));

  // å¯¾è±¡ç”»é¢ã‚’è¡¨ç¤º
  document.getElementById(targetId).classList.add('active');
  document.querySelector(`.nav-btn[data-target="${targetId}"]`).classList.add('active');

  // é€²æ—ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãŸã³ã«ã‚°ãƒ©ãƒ•ã‚’å†æç”»
  if (targetId === 'screen-progress') renderProgress();
}

navBtns.forEach(btn => {
  btn.addEventListener('click', () => switchScreen(btn.dataset.target));
});

/* ================================================================
   1. ç›®æ¨™è¨­å®šç”»é¢ ãƒ­ã‚¸ãƒƒã‚¯
================================================================ */

/** ç¾åœ¨ã®ç›®æ¨™ã‚’ UI ã«åæ˜ ã™ã‚‹ */
function renderGoalScreen() {
  const data = loadData();
  document.getElementById('goal-display-min').textContent = data.goal.targetMinutes;
  document.getElementById('goal-input').value = '';
}

/** ä¿å­˜ãƒœã‚¿ãƒ³ */
document.getElementById('btn-save-goal').addEventListener('click', () => {
  const val = parseInt(document.getElementById('goal-input').value, 10);
  if (!val || val <= 0) {
    showToast('æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const data = loadData();
  data.goal = { mode: 'weekly', targetMinutes: val };
  saveData(data);
  renderGoalScreen();   // è¡¨ç¤ºã‚’æ›´æ–°
  showToast(`ç›®æ¨™ã‚’ ${val} åˆ†ã«è¨­å®šã—ã¾ã—ãŸï¼`);
});

/** ã‚¯ã‚¤ãƒƒã‚¯è¨­å®šãƒœã‚¿ãƒ³ç¾¤ */
document.querySelectorAll('.quick-goal').forEach(btn => {
  btn.addEventListener('click', () => {
    const min = parseInt(btn.dataset.min, 10);
    document.getElementById('goal-input').value = min;
    // ãã®ã¾ã¾ä¿å­˜
    document.getElementById('btn-save-goal').click();
  });
});

/* ================================================================
   ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒæ©Ÿèƒ½
================================================================ */

/** ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ */
document.getElementById('btn-export').addEventListener('click', () => {
  try {
    const data = loadData();
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `studylog-backup-${toDateStr(new Date())}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    showToast('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ ğŸ’¾');
  } catch (e) {
    console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—:', e);
    showToast('âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
});

/** JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ */
document.getElementById('btn-import').addEventListener('click', () => {
  document.getElementById('file-import').click();
});

document.getElementById('file-import').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      
      // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
      if (!validateData(imported)) {
        showToast('âš ï¸ ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
        return;
      }
      
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const confirm = window.confirm(
        `ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\n\n` +
        `å¾©å…ƒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼š\n` +
        `ãƒ»è¨˜éŒ²æ•°: ${imported.records.length}ä»¶\n` +
        `ãƒ»ç›®æ¨™: ${imported.goal.targetMinutes}åˆ†/é€±`
      );
      
      if (confirm) {
        const success = saveData(imported);
        if (success) {
          showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ âœ¨');
          renderGoalScreen();
          renderRecentList();
          // é€²æ—ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å†æç”»
          if (document.getElementById('screen-progress').classList.contains('active')) {
            renderProgress();
          }
        } else {
          showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    } catch (e) {
      console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—:', e);
      showToast('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    e.target.value = '';
  };
  
  reader.readAsText(file);
});

/* ================================================================
   2. è¨˜éŒ²ç”»é¢ ãƒ­ã‚¸ãƒƒã‚¯
   â˜… ã‚¹ãƒªãƒ¼ãƒ—å¯¾å¿œ:
      - é–‹å§‹æ™‚åˆ»(Unix ms)ã‚’ localStorage ã«ä¿å­˜ã—ã€ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿å¾Œã‚‚å¾©å…ƒ
      - è¡¨ç¤ºã¯ setInterval ã®ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ãªãã€Œç¾åœ¨æ™‚åˆ» - é–‹å§‹æ™‚åˆ»ã€ã®å·®åˆ†ã§è¨ˆç®—
        â†’ ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã« setInterval ãŒæ­¢ã¾ã£ã¦ã‚‚ã€å¾©å¸°å¾Œã«æ­£ç¢ºãªæ™‚é–“ã¸å³è£œæ­£
      - visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆã§ç”»é¢å¾©å¸°ã‚’æ¤œçŸ¥ã—ã¦å³æ™‚å†æç”»
================================================================ */

// LocalStorage ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã‚­ãƒ¼ï¼ˆã‚¿ã‚¤ãƒãƒ¼ç¨¼åƒä¸­ã®ã¿ä¿å­˜ï¼‰
const TIMER_SESSION_KEY = 'studylog_timer_session';

let selectedSubject = null;  // ç¾åœ¨é¸æŠä¸­ã®ç§‘ç›®
let timerInterval   = null;  // è¡¨ç¤ºæ›´æ–°ç”¨ setInterval ID

const btnStart    = document.getElementById('btn-start');
const btnStop     = document.getElementById('btn-stop');
const timerClock  = document.getElementById('timer-clock');
const timerStatus = document.getElementById('timer-status');

/** Unix ms ã‚’ "HH:MM" å½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ› */
function formatStartTime(startMs) {
  const d = new Date(startMs);
  const h = String(d.getHours()).padStart(2, '0');
  const m = String(d.getMinutes()).padStart(2, '0');
  return `${h}:${m}`;
}

/**
 * ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ localStorage ã«ä¿å­˜ã™ã‚‹
 * ã‚¹ãƒªãƒ¼ãƒ—ãƒ»ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚é–‹å§‹æ™‚åˆ»ã‚’å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
 */
function saveTimerSession(subject, startMs) {
  localStorage.setItem(TIMER_SESSION_KEY, JSON.stringify({ subject, startMs }));
}

/** ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ */
function clearTimerSession() {
  localStorage.removeItem(TIMER_SESSION_KEY);
}

/** ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€ã€‚å­˜åœ¨ã—ãªã‘ã‚Œã° null ã‚’è¿”ã™ */
function loadTimerSession() {
  try {
    const raw = localStorage.getItem(TIMER_SESSION_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

/**
 * é–‹å§‹æ™‚åˆ»ã‚’ "HH:MM é–‹å§‹" ã¨è¡¨ç¤ºã™ã‚‹ï¼ˆæ›´æ–°ä¸è¦ãƒ»ä¸€åº¦ã ã‘å‘¼ã¶ï¼‰
 */
function tickTimer(startMs) {
  timerClock.textContent = formatStartTime(startMs);
}

/**
 * ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹ï¼ˆå†…éƒ¨å‡¦ç†ï¼‰
 * @param {string} subject  - ç§‘ç›®å
 * @param {number} startMs  - é–‹å§‹æ™‚åˆ»ï¼ˆUnix ãƒŸãƒªç§’ï¼‰
 */
function startTimerUI(subject, startMs) {
  selectedSubject = subject;

  // UI æ›´æ–°
  btnStart.disabled = true;
  btnStop.disabled  = false;
  timerClock.classList.add('running');
  document.getElementById('timer-clock-label').textContent = 'é–‹å§‹æ™‚åˆ»';
  timerStatus.textContent = `${subject} â€” è¨ˆæ¸¬ä¸­ï¼ˆçµ‚äº†ã—ãŸã‚‰ã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰`;

  // ç§‘ç›®ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
  document.querySelectorAll('.subject-btn').forEach(b => {
    b.classList.toggle('selected', b.dataset.subject === subject);
  });

  // é–‹å§‹æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆä¸€åº¦ã ã‘æç”»ã™ã‚Œã°ã‚ˆã„ã€‚æ›´æ–°ä¸è¦ï¼‰
  tickTimer(startMs);

  // é–‹å§‹æ™‚åˆ»ã®è¡¨ç¤ºã¯å›ºå®šå€¤ãªã®ã§ setInterval ã¯ä¸è¦
  clearInterval(timerInterval);
  timerInterval = null;
}

/** ç§‘ç›®ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç† */
document.querySelectorAll('.subject-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // ã‚¿ã‚¤ãƒãƒ¼ç¨¼åƒä¸­ã¯ç§‘ç›®å¤‰æ›´ä¸å¯
    if (loadTimerSession()) {
      showToast('è¨ˆæ¸¬ä¸­ã¯ç§‘ç›®ã‚’å¤‰æ›´ã§ãã¾ã›ã‚“');
      return;
    }
    document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedSubject = btn.dataset.subject;

    btnStart.disabled = false;
    timerStatus.textContent = `${selectedSubject}ã‚’å‹‰å¼·ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸ`;
  });
});

/** é–‹å§‹ãƒœã‚¿ãƒ³ */
btnStart.addEventListener('click', () => {
  if (!selectedSubject) return;

  const startMs = Date.now(); // é–‹å§‹æ™‚åˆ»ã‚’ Unix ms ã§è¨˜éŒ²

  // â˜… localStorage ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼ˆã‚¹ãƒªãƒ¼ãƒ—ãƒ»ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
  saveTimerSession(selectedSubject, startMs);

  startTimerUI(selectedSubject, startMs);
});

/** çµ‚äº†ãƒœã‚¿ãƒ³ */
btnStop.addEventListener('click', () => {
  const session = loadTimerSession();
  if (!session) return;

  // â˜… é–‹å§‹æ™‚åˆ»ã¯ localStorage ã‹ã‚‰å–å¾— â†’ setInterval ã®ã‚ºãƒ¬ã«å·¦å³ã•ã‚Œãªã„æ­£ç¢ºãªè¨ˆç®—
  const durationMs  = Date.now() - session.startMs;
  const durationMin = Math.max(1, Math.round(durationMs / 60000));
  const endTime     = new Date();

  // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
  clearInterval(timerInterval);
  timerInterval = null;

  // â˜…â˜… é‡è¦ï¼šè¨˜éŒ²ä¿å­˜ã®å‰ã«ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  const sessionBackup = JSON.stringify(session);
  
  // LocalStorage ã«è¨˜éŒ²ã‚’è¿½åŠ 
  const data = loadData();
  const newRecord = {
    date:      toDateStr(endTime),
    subject:   session.subject,
    duration:  durationMin,
    timestamp: endTime.getTime(),  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿å¾©æ—§æ™‚ã®è­˜åˆ¥ç”¨ï¼‰
  };
  data.records.push(newRecord);
  
  // â˜…â˜… ä¿å­˜æˆåŠŸã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
  const saveSuccess = saveData(data);
  
  if (saveSuccess) {
    // ä¿å­˜æˆåŠŸï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
    clearTimerSession();
    
    // UI ãƒªã‚»ãƒƒãƒˆ
    selectedSubject = null;
    btnStart.disabled = false;
    btnStop.disabled  = true;
    timerClock.classList.remove('running');
    timerClock.textContent  = '--:--';
    document.getElementById('timer-clock-label').textContent = 'ã€€';
    timerStatus.textContent = `${session.subject} ${durationMin}åˆ† ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`;

    // ç§‘ç›®ãƒœã‚¿ãƒ³ã®é¸æŠè§£é™¤
    document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('selected'));

    showToast(`${session.subject} ${durationMin}åˆ† ã‚’ä¿å­˜ã—ã¾ã—ãŸ ğŸ‰`);
    renderRecentList();
  } else {
    // ä¿å­˜å¤±æ•—ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ®‹ã—ã¦å†è©¦è¡Œå¯èƒ½ã«ã™ã‚‹
    showToast('âš ï¸ ä¿å­˜å¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');
    console.error('è¨˜éŒ²ä¿å­˜å¤±æ•—ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä¿æŒã•ã‚Œã¾ã™:', sessionBackup);
  }
});

/**
 * â˜… visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¹ãƒªãƒ¼ãƒ—ãƒ»ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‹ã‚‰ã®å¾©å¸°ã‚’æ¤œçŸ¥
 * ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã¯ setInterval ãŒåœæ­¢ã™ã‚‹ãŒã€å¾©å¸°ã—ãŸç¬é–“ã«
 * Date.now() ãƒ™ãƒ¼ã‚¹ã§æ­£ç¢ºãªæ™‚é–“ã‚’å†è¨ˆç®—ãƒ»å†æç”»ã™ã‚‹
 */
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    const session = loadTimerSession();
    if (session) {
      // å¾©å¸°æ™‚ã«é–‹å§‹æ™‚åˆ»ã‚’å†æç”»ï¼ˆå¿µã®ãŸã‚ï¼‰
      tickTimer(session.startMs);
    }
  }
});

/** ç›´è¿‘5ä»¶ã®è¨˜éŒ²ãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹ */
function renderRecentList() {
  const data    = loadData();
  const recent  = data.records.slice(-5).reverse(); // æœ€æ–°5ä»¶
  const listEl  = document.getElementById('recent-list');

  if (recent.length === 0) {
    listEl.innerHTML = '<li class="empty-msg">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }

  listEl.innerHTML = recent.map(r => {
    const color = SUBJECT_COLORS[r.subject] || '#8892a4';
    return `
      <li class="record-item">
        <span class="record-dot" style="background:${color}"></span>
        <div class="record-info">
          <div class="record-subject" style="color:${color}">${r.subject}</div>
          <div class="record-date">${r.date}</div>
        </div>
        <div class="record-dur">${r.duration}åˆ†</div>
      </li>
    `;
  }).join('');
}

/* ================================================================
   3. é€²æ—ç”»é¢ ãƒ­ã‚¸ãƒƒã‚¯
================================================================ */
let subjectChartInst = null; // Chart.js ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆç§‘ç›®åˆ¥ï¼‰
let dailyChartInst   = null; // Chart.js ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆæ—¥åˆ¥ï¼‰

/** é€²æ—ç”»é¢å…¨ä½“ã‚’å†æç”»ã™ã‚‹ */
function renderProgress() {
  const data        = loadData();
  const weekRecords = getWeekRecords(data.records);
  const target      = data.goal.targetMinutes;

  // åˆè¨ˆæ™‚é–“
  const totalMin = weekRecords.reduce((sum, r) => sum + r.duration, 0);

  // é”æˆç‡ï¼ˆæœ€å¤§100%ï¼‰
  const pct = target > 0 ? Math.min(100, Math.round(totalMin / target * 100)) : 0;

  // â‘  é”æˆç‡ãƒªãƒ³ã‚°æ›´æ–°
  const circumference = 427.26; // 2Ï€ Ã— 68
  const offset = circumference * (1 - pct / 100);
  document.getElementById('ring-fg').style.strokeDashoffset = offset;
  document.getElementById('ring-pct').textContent = `${pct}%`;

  // â‘¡ çµ±è¨ˆã‚«ãƒ¼ãƒ‰æ›´æ–°
  const totalEl  = document.getElementById('stat-total');
  const remainEl = document.getElementById('stat-remain');
  totalEl.innerHTML  = `${totalMin}<span class="stat-unit">åˆ†</span>`;
  totalEl.className  = 'stat-val good';

  const remain = target - totalMin;
  if (target <= 0) {
    remainEl.innerHTML = `---<span class="stat-unit">åˆ†</span>`;
    remainEl.className = 'stat-val';
  } else if (remain <= 0) {
    remainEl.innerHTML = `é”æˆ!<span class="stat-unit"></span>`;
    remainEl.className = 'stat-val good';
  } else {
    remainEl.innerHTML = `${remain}<span class="stat-unit">åˆ†</span>`;
    remainEl.className = `stat-val ${remain < target * 0.3 ? 'warn' : ''}`;
  }

  // â‘¢ ç§‘ç›®åˆ¥æ£’ã‚°ãƒ©ãƒ•
  const subjects = Object.keys(SUBJECT_COLORS);
  const subjectTotals = subjects.map(sub =>
    weekRecords.filter(r => r.subject === sub).reduce((s, r) => s + r.duration, 0)
  );

  const chartDefaults = {
    color: '#8892a4',
    borderRadius: 8,
    borderSkipped: false,
  };

  if (subjectChartInst) subjectChartInst.destroy();
  subjectChartInst = new Chart(
    document.getElementById('subject-chart').getContext('2d'),
    {
      type: 'bar',
      data: {
        labels: subjects,
        datasets: [{
          label: 'å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
          data: subjectTotals,
          backgroundColor: subjects.map(s => SUBJECT_COLORS[s] + 'cc'),
          borderColor:     subjects.map(s => SUBJECT_COLORS[s]),
          borderWidth: 2,
          ...chartDefaults,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e2029',
            borderColor: '#2a2d3a',
            borderWidth: 1,
            titleColor: '#e2e8f0',
            bodyColor: '#8892a4',
            callbacks: {
              label: ctx => ` ${ctx.parsed.y} åˆ†`,
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#8892a4', font: { family: 'Noto Sans JP', size: 12 } },
          },
          y: {
            grid: { color: '#2a2d3a', drawBorder: false },
            ticks: {
              color: '#8892a4',
              font: { family: 'Lexend', size: 11 },
              callback: v => `${v}åˆ†`,
            },
            beginAtZero: true,
          },
        },
      },
    }
  );

  // â‘£ æ—¥åˆ¥æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
  const weekDates = getWeekDates();
  const dailyTotals = weekDates.map(d =>
    weekRecords.filter(r => r.date === d).reduce((s, r) => s + r.duration, 0)
  );
  const dayLabels = weekDates.map(d => {
    const [, m, day] = d.split('-');
    return `${parseInt(m)}/${parseInt(day)}`;
  });

  if (dailyChartInst) dailyChartInst.destroy();
  dailyChartInst = new Chart(
    document.getElementById('daily-chart').getContext('2d'),
    {
      type: 'bar',
      data: {
        labels: dayLabels,
        datasets: [{
          label: 'å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰',
          data: dailyTotals,
          backgroundColor: '#818cf833',
          borderColor: '#818cf8',
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e2029',
            borderColor: '#2a2d3a',
            borderWidth: 1,
            titleColor: '#e2e8f0',
            bodyColor: '#8892a4',
            callbacks: { label: ctx => ` ${ctx.parsed.y} åˆ†` },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#8892a4', font: { family: 'Lexend', size: 11 } },
          },
          y: {
            grid: { color: '#2a2d3a' },
            ticks: {
              color: '#8892a4',
              font: { family: 'Lexend', size: 11 },
              callback: v => `${v}åˆ†`,
            },
            beginAtZero: true,
          },
        },
      },
    }
  );
}

/* ================================================================
   ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸåŒ–
================================================================ */
(function init() {
  renderGoalScreen();   // ç›®æ¨™ç”»é¢ã‚’åˆæœŸè¡¨ç¤º
  renderRecentList();   // è¨˜éŒ²ä¸€è¦§ã‚’åˆæœŸè¡¨ç¤º

  // â˜… ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å¾©å…ƒ
  // ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã«ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå ´åˆã‚‚
  // localStorage ã«ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰è¨ˆæ¸¬ã‚’å†é–‹ã™ã‚‹
  const session = loadTimerSession();
  if (session) {
    switchScreen('screen-record');
    startTimerUI(session.subject, session.startMs);
    showToast(`${session.subject} ã®è¨ˆæ¸¬ã‚’å†é–‹ã—ã¾ã—ãŸ`);
  }

  // â˜…â˜… å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ã”ã¨ï¼‰
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã®ç ´æã‚’æ¤œå‡ºã—ã€è‡ªå‹•ä¿®å¾©ã‚’è©¦ã¿ã‚‹
  setInterval(() => {
    try {
      const data = loadData();
      // ãƒ‡ãƒ¼ã‚¿ãŒèª­ã‚ã‚Œã°OKï¼ˆloadDataå†…ã§è‡ªå‹•ä¿®å¾©ã•ã‚Œã¦ã„ã‚‹ï¼‰
    } catch (e) {
      console.error('[æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯] ãƒ‡ãƒ¼ã‚¿ç•°å¸¸ã‚’æ¤œå‡º:', e);
    }
  }, 5 * 60 * 1000); // 5åˆ† = 300,000ãƒŸãƒªç§’

  // â˜…â˜… ãƒšãƒ¼ã‚¸é›¢è„±å‰ã®æœ€çµ‚ä¿å­˜ç¢ºèª
  window.addEventListener('beforeunload', () => {
    // ã‚¿ã‚¤ãƒãƒ¼ç¨¼åƒä¸­ã®å ´åˆã¯è­¦å‘Š
    const session = loadTimerSession();
    if (session) {
      // ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      return 'è¨ˆæ¸¬ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚æœ¬å½“ã«é–‰ã˜ã¾ã™ã‹ï¼Ÿ';
    }
  });
})();
</script>

</body>
</html>